name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Fetch tags with annotations
        run: git fetch --tags --force

      - name: Get tag info
        id: tag_info
        run: |
          # Get the previous tag (the one before the current tag)
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG:-'(none - first release)'}"

          # Get the annotated tag message (for release title)
          # Use git cat-file to read the tag object and extract the message
          TAG_MESSAGE=$(git cat-file tag "${{ github.ref_name }}" 2>/dev/null | sed -n '/^$/,$p' | sed '1d' | head -1)
          echo "message=${TAG_MESSAGE}" >> $GITHUB_OUTPUT
          echo "Tag message: ${TAG_MESSAGE:-'(none)'}"

      - name: Generate release notes
        id: release_notes
        run: |
          TAG=${{ github.ref_name }}
          PREV_TAG="${{ steps.tag_info.outputs.prev_tag }}"
          REPO="${{ github.repository }}"

          if [ -z "$PREV_TAG" ]; then
            echo "First release - including all commits"
            COMMITS=$(git log --pretty=format:"- %s ([%h](https://github.com/${REPO}/commit/%H))")
          else
            echo "Generating changelog from ${PREV_TAG} to ${TAG}"
            COMMITS=$(git log ${PREV_TAG}..${TAG} --pretty=format:"- %s ([%h](https://github.com/${REPO}/commit/%H))")
          fi

          # Write header and commits to file
          echo "## Commits in this release" > /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "$COMMITS" >> /tmp/release_notes.md

          # Show what will be included
          echo "Release notes:"
          cat /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ steps.tag_info.outputs.message && format('{0} - {1}', github.ref_name, steps.tag_info.outputs.message) || github.ref_name }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
