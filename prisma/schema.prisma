// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// Secondary generator for worker threads (JavaScript, default location)
generator workerClient {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Enums

/// Monitoring intent - does the user want this content?
enum MonitorStatus {
  WANTED
  UNWANTED
}

/// Quality state for files
enum FileQuality {
  UNVERIFIED
  VERIFIED    // All required playback tests pass
  OK          // Reserved for future quality property checks
  BROKEN
}

/// Recommended action for a file
enum Action {
  NOTHING
  REDOWNLOAD
  CONVERT
  ORGANIZE
  REPAIR
}

/// Playback test result
enum PlaybackStatus {
  PASS        // Plays without issues
  PARTIAL     // Plays with transcoding/conditions
  FAIL        // Does not play
}

/// Scan job status
enum ScanStatus {
  RUNNING
  COMPLETED
  FAILED
}

// TV Show Models
model TVShow {
  id            Int           @id @default(autoincrement())
  title         String
  folderName    String?       // Original folder name on disk (can differ from display title)
  year          Int?
  tvdbId        String?       @unique
  tmdbId        Int?          @unique
  plexId        String?       @unique
  monitorStatus MonitorStatus @default(WANTED)
  notes         String?

  // TMDB Metadata
  posterPath       String?
  backdropPath     String?
  description      String?
  firstAirDate     DateTime?
  voteAverage      Float?
  genres           String?   // JSON array: ["Drama", "Sci-Fi"]
  networkStatus    String?   // "Returning Series", "Ended", "Canceled"
  originalLanguage String?   // ISO 639-1 code: "en", "ja", etc.
  tmdbSeasonCount  Int?
  tmdbEpisodeCount Int?
  lastMetadataSync DateTime?

  seasons   Season[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])
  @@index([tmdbId])
}

model Season {
  id            Int           @id @default(autoincrement())
  tvShowId      Int
  tvShow        TVShow        @relation(fields: [tvShowId], references: [id], onDelete: Cascade)
  seasonNumber  Int
  name          String?       // Season name from TMDB (e.g., "Specials", "Season 1: The Beginning")
  monitorStatus MonitorStatus @default(WANTED)
  notes         String?

  // TMDB Metadata
  tmdbSeasonId Int?
  posterPath   String?
  description  String?
  airDate      DateTime?

  episodes     Episode[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tvShowId, seasonNumber])
  @@index([tvShowId])
}

model Episode {
  id            Int           @id @default(autoincrement())
  seasonId      Int
  season        Season        @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  episodeNumber Int
  title         String?
  monitorStatus MonitorStatus @default(WANTED)
  notes         String?

  // TMDB Metadata
  tmdbEpisodeId Int?
  stillPath     String?   // Episode screenshot
  description   String?
  airDate       DateTime?
  runtime       Int?      // Duration in minutes
  voteAverage   Float?

  files         EpisodeFile[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([seasonId, episodeNumber])
  @@index([seasonId])
}

model EpisodeFile {
  id                Int      @id @default(autoincrement())
  episodeId         Int
  episode           Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  filepath          String   @unique
  filename          String
  fileSize          BigInt
  dateModified      DateTime
  fileExists        Boolean  @default(true)

  quality           FileQuality @default(UNVERIFIED)
  action            Action      @default(NOTHING)
  notes             String?

  codec             String?
  resolution        String?
  bitrate           Int?
  container         String?
  audioFormat       String?
  hdrType           String?
  duration          Int?

  metadataSource    String?
  plexMatched       Boolean  @default(false)

  audioLanguages    String?
  subtitleLanguages String?

  playbackTests PlaybackTest[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([episodeId])
  @@index([quality])
  @@index([action])
}

/// Playback test platforms (TV, Web Player, Mobile, etc.)
model Platform {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  isRequired  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  playbackTests PlaybackTest[]
}

/// Playback test results per file
model PlaybackTest {
  id            Int            @id @default(autoincrement())
  episodeFileId Int?
  episodeFile   EpisodeFile?   @relation(fields: [episodeFileId], references: [id], onDelete: Cascade)
  movieFileId   Int?           // Future: for movies

  platformId    Int
  platform      Platform       @relation(fields: [platformId], references: [id])
  status        PlaybackStatus
  notes         String?
  testedAt      DateTime       @default(now())

  @@index([episodeFileId])
  @@index([platformId])
}

model ScanHistory {
  id            Int      @id @default(autoincrement())
  scanType      String
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  filesScanned  Int      @default(0)
  filesAdded    Int      @default(0)
  filesUpdated  Int      @default(0)
  filesDeleted  Int      @default(0)
  errors        String?
  status        ScanStatus
}

// App Settings (single row with id=1)
model Settings {
  id               Int      @id @default(1)
  dateFormat       String   @default("EU") // EU (DD/MM/YYYY), US (MM/DD/YYYY), ISO (YYYY-MM-DD)
  maxParallelTasks Int      @default(2) // Maximum number of concurrent tasks
  updatedAt        DateTime @updatedAt
}
